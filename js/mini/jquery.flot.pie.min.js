(function(e){function r(r){function p(t,n,r){if(!l){l=true;s=t.getCanvas();o=e(s).parent();i=t.getOptions();t.setData(d(t.getData()))}}function d(t){var n=0,r=0,s=0,o=i.series.pie.combine.color,u=[];for(var a=0;a<t.length;++a){var f=t[a].data;if(e.isArray(f)&&f.length==1){f=f[0]}if(e.isArray(f)){if(!isNaN(parseFloat(f[1]))&&isFinite(f[1])){f[1]=+f[1]}else{f[1]=0}}else if(!isNaN(parseFloat(f))&&isFinite(f)){f=[1,+f]}else{f=[1,0]}t[a].data=[f]}for(var a=0;a<t.length;++a){n+=t[a].data[0][1]}for(var a=0;a<t.length;++a){var f=t[a].data[0][1];if(f/n<=i.series.pie.combine.threshold){r+=f;s++;if(!o){o=t[a].color}}}for(var a=0;a<t.length;++a){var f=t[a].data[0][1];if(s<2||f/n>i.series.pie.combine.threshold){u.push({data:[[1,f]],color:t[a].color,label:t[a].label,explode:t[a].explode,angle:f*Math.PI*2/n,percent:f/(n/100),h3:t[a].h3,h4:t[a].h4,h6:t[a].h6,li:t[a].li,desc:t[a].desc,circ:t[a].circ,pdf:t[a].pdf})}}if(s>1){u.push({data:[[1,r]],color:o,label:i.series.pie.combine.label,angle:r*Math.PI*2/n,percent:r/(n/100)})}return u}function v(r,s){function y(){c.clearRect(0,0,h,p);o.children().filter(".pieLabel, .pieLabelBackground").remove()}function b(){var e=i.series.pie.shadow.left;var t=i.series.pie.shadow.top;var n=10;var r=i.series.pie.shadow.alpha;var s=i.series.pie.radius>1?i.series.pie.radius:u*i.series.pie.radius;if(s>=h/2-e||s*i.series.pie.tilt>=p/2-t||s<=n){return}c.save();c.translate(e,t);c.globalAlpha=r;c.fillStyle="#000";c.translate(a,f);c.scale(1,i.series.pie.tilt);for(var o=1;o<=n;o++){c.beginPath();c.arc(0,0,s,0,Math.PI*2,false);c.fill();s-=o}c.restore()}function w(){function l(e,t,i,s){s=n*(s||0);if(e<=0||isNaN(e)){return}if(i){c.fillStyle=t}else{c.strokeStyle=t;c.lineJoin="round"}c.beginPath();if(Math.abs(e-Math.PI*2)>1e-9){c.moveTo(0,0)}var o=Math.cos(r+e/2)*s;var u=Math.sin(r+e/2)*s;c.moveTo(o,u);c.arc(o,u,n,r,r+e/2,false);c.arc(o,u,n,r+e/2,r+e,false);c.closePath();r+=e;if(i){c.fill()}else{c.stroke()}}function d(){function l(t,n,s,u){if(t.data[0][1]==0){return true}u=r*(u||0);var l=i.legend.labelFormatter,c,d=i.series.pie.label.formatter;if(l){c=l(t.label,t)}else{c=t.label}if(d){c=d(c,t)}var v=(n+t.angle+n)/2;var m=a+Math.round(Math.cos(v)*(r+u));var g=f+Math.round(Math.sin(v)*(r+u))*i.series.pie.tilt;var y="<span class='pieLabel' id='pieLabel"+s+"' style='position:absolute;top:"+g+"px;left:"+m+"px;'>"+c+"</span>";o.append(y);var b=o.children("#pieLabel"+s);var w=g-b.height()/2;var E=m-b.width()/2;b.css("top",w);b.css("left",E);if(0-w>0||0-E>0||p-(w+b.height())<0||h-(E+b.width())<0){return false}if(i.series.pie.label.background.opacity!=0){var S=i.series.pie.label.background.color;if(S==null){S=t.color}var x="top:"+w+"px;left:"+E+"px;";e("<div class='pieLabelBackground' style='position:absolute;width:"+b.width()+"px;height:"+b.height()+"px;"+x+"background-color:"+S+";'></div>").css("opacity",i.series.pie.label.background.opacity).insertBefore(b)}return true}var n=t;var r=i.series.pie.label.radius>1?i.series.pie.label.radius:u*i.series.pie.label.radius;for(var s=0;s<v.length;++s){if(v[s].percent>=i.series.pie.label.threshold*100){if(!l(v[s],n,s,v[s].explode||0)){return false}}n+=v[s].angle}return true}var t=Math.PI*i.series.pie.startAngle;var n=i.series.pie.radius>1?i.series.pie.radius:u*i.series.pie.radius;c.save();c.translate(a,f);c.scale(1,i.series.pie.tilt);c.save();var r=t;for(var s=0;s<v.length;++s){v[s].startAngle=r;l(v[s].angle,v[s].color,true,v[s].explode||0)}c.restore();if(i.series.pie.stroke.width>0){c.save();r=t;for(var s=0;s<v.length;++s){c.lineWidth=i.series.pie.stroke.width;l(v[s].angle,i.series.pie.stroke.color,false,v[s].explode||0)}c.restore()}m(c);c.restore();if(i.series.pie.label.show){return d()}else return true}if(!o){return}var h=r.getPlaceholder().width(),p=r.getPlaceholder().height(),d=o.children().filter(".legend").children().width()||0;c=s;l=false;u=Math.min(h,p/i.series.pie.tilt)/2;f=p/2+i.series.pie.offset.top;a=h/2;if(i.series.pie.offset.left=="auto"){if(i.legend.position.match("w")){a+=d/2}else{a-=d/2}}else{a+=i.series.pie.offset.left}if(a<u){a=u}else if(a>h-u){a=h-u}var v=r.getData(),g=0;do{if(g>0){u*=n}g+=1;y();if(i.series.pie.tilt<=.8){b()}}while(!w()&&g<t);if(g>=t){y();o.prepend("<div class='error'>Could not draw pie with labels contained inside canvas</div>")}if(r.setSeries&&r.insertLegend){r.setSeries(v);r.insertLegend()}}function m(e){if(i.series.pie.innerRadius>0){e.save();var t=i.series.pie.innerRadius>1?i.series.pie.innerRadius:u*i.series.pie.innerRadius;e.globalCompositeOperation="destination-out";e.beginPath();e.fillStyle=i.series.pie.stroke.color;e.arc(0,0,t,0,Math.PI*2,false);e.fill();e.closePath();e.restore();e.save();e.beginPath();e.strokeStyle=i.series.pie.stroke.color;e.arc(0,0,t,0,Math.PI*2,false);e.stroke();e.closePath();e.restore()}}function g(e,t){for(var n=false,r=-1,i=e.length,s=i-1;++r<i;s=r)(e[r][1]<=t[1]&&t[1]<e[s][1]||e[s][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[s][0]-e[r][0])*(t[1]-e[r][1])/(e[s][1]-e[r][1])+e[r][0]&&(n=!n);return n}function y(e,t){var n=r.getData(),i=r.getOptions(),s=i.series.pie.radius>1?i.series.pie.radius:u*i.series.pie.radius,o,l;for(var h=0;h<n.length;++h){var p=n[h];if(p.pie.show){c.save();c.beginPath();c.moveTo(0,0);c.arc(0,0,s,p.startAngle,p.startAngle+p.angle/2,false);c.arc(0,0,s,p.startAngle+p.angle/2,p.startAngle+p.angle,false);c.closePath();o=e-a;l=t-f;if(c.isPointInPath){if(c.isPointInPath(e-a,t-f)){c.restore();return{datapoint:[p.percent,p.data],dataIndex:0,series:p,seriesIndex:h}}}else{var d=s*Math.cos(p.startAngle),v=s*Math.sin(p.startAngle),m=s*Math.cos(p.startAngle+p.angle/4),y=s*Math.sin(p.startAngle+p.angle/4),b=s*Math.cos(p.startAngle+p.angle/2),w=s*Math.sin(p.startAngle+p.angle/2),E=s*Math.cos(p.startAngle+p.angle/1.5),S=s*Math.sin(p.startAngle+p.angle/1.5),x=s*Math.cos(p.startAngle+p.angle),T=s*Math.sin(p.startAngle+p.angle),N=[[0,0],[d,v],[m,y],[b,w],[E,S],[x,T]],C=[o,l];if(g(N,C)){c.restore();return{datapoint:[p.percent,p.data],dataIndex:0,series:p,seriesIndex:h}}}c.restore()}}return null}function b(e){E("plothover",e)}function w(e){E("plotclick",e)}function E(e,t){var n=r.offset();var s=parseInt(t.pageX-n.left);var u=parseInt(t.pageY-n.top);var a=y(s,u);if(i.grid.autoHighlight){for(var f=0;f<h.length;++f){var l=h[f];if(l.auto==e&&!(a&&l.series==a.series)){x(l.series)}}}if(a){S(a.series,e)}var c={pageX:t.pageX,pageY:t.pageY};o.trigger(e,[c,a])}function S(e,t){var n=T(e);if(n==-1){h.push({series:e,auto:t});r.triggerRedrawOverlay()}else if(!t){h[n].auto=false}}function x(e){if(e==null){h=[];r.triggerRedrawOverlay()}var t=T(e);if(t!=-1){h.splice(t,1);r.triggerRedrawOverlay()}}function T(e){for(var t=0;t<h.length;++t){var n=h[t];if(n.series==e)return t}return-1}function N(e,t){function s(e){if(e.angle<=0||isNaN(e.angle)){return}var i=r*(e.explode||0);t.fillStyle="rgba(255, 255, 255, "+n.series.pie.highlight.opacity+")";t.beginPath();if(Math.abs(e.angle-Math.PI*2)>1e-9){t.moveTo(0,0)}var s=Math.cos(e.startAngle+e.angle/2)*i;var o=Math.sin(e.startAngle+e.angle/2)*i;t.moveTo(s,o);t.arc(s,o,r,e.startAngle,e.startAngle+e.angle/2,false);t.arc(s,o,r,e.startAngle+e.angle/2,e.startAngle+e.angle,false);t.closePath();t.fill()}var n=e.getOptions();var r=n.series.pie.radius>1?n.series.pie.radius:u*n.series.pie.radius;t.save();t.translate(a,f);t.scale(1,n.series.pie.tilt);for(var i=0;i<h.length;++i){s(h[i].series)}m(t);t.restore()}var s=null,o=null,u=null,a=null,f=null,l=false,c=null;var h=[];r.hooks.processOptions.push(function(e,t){if(t.series.pie.show){t.grid.show=false;if(t.series.pie.label.show=="auto"){if(t.legend.show){t.series.pie.label.show=false}else{t.series.pie.label.show=true}}if(t.series.pie.radius=="auto"){if(t.series.pie.label.show){t.series.pie.radius=3/4}else{t.series.pie.radius=1}}if(t.series.pie.tilt>1){t.series.pie.tilt=1}else if(t.series.pie.tilt<0){t.series.pie.tilt=0}}});r.hooks.bindEvents.push(function(e,t){var n=e.getOptions();if(n.series.pie.show){if(n.grid.hoverable){t.unbind("mousemove").mousemove(b)}if(n.grid.clickable){t.unbind("click").click(w)}}});r.hooks.processDatapoints.push(function(e,t,n,r){var i=e.getOptions();if(i.series.pie.show){p(e,t,n,r)}});r.hooks.drawOverlay.push(function(e,t){var n=e.getOptions();if(n.series.pie.show){N(e,t)}});r.hooks.draw.push(function(e,t){var n=e.getOptions();if(n.series.pie.show){v(e,t)}})}var t=10;var n=.95;var i={series:{pie:{show:false,radius:"auto",innerRadius:0,startAngle:3/2,tilt:1,shadow:{left:5,top:15,alpha:.02},offset:{top:0,left:"auto"},stroke:{color:"#fff",width:1},label:{show:"auto",formatter:function(e,t){return"<div style='font-size:x-small;text-align:center;padding:2px;color:"+t.color+";'>"+e+"<br/>"+Math.round(t.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:.5}}}};e.plot.plugins.push({init:r,options:i,name:"pie",version:"1.1"})})(jQuery)